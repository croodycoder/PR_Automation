# Webhook-based PR Test Automation for Django Project

This project automates the process of running tests, generating coverage reports, and posting the results to a GitHub pull request (PR) using a Flask application. When a PR is opened or updated, it triggers tests in a Django repository, generates HTML reports, and posts the results back to the PR in the form of comments with links to the reports.

---

## Features
- Automatically runs tests and coverage for PRs.
- Posts coverage and test reports as comments on PRs.
- Publishes reports on GitHub Pages.

---

## Setup and Installation



### Step 1: Fork and Clone the Repository
1. Fork this repository.
2. Clone it 
   ```bash
   git clone https://github.com/<YOUR_USERNAME>/pr-automation.git
   cd pr-automation
    ```

## Step 2: Set Up Codespaces
1. Open GitHub and navigate to your repository.
2. Click the "Code" button and select "Open with Codespaces".
3. Follow the prompts to create a new Codespace environment. Once the environment is set up, you'll be able to access the project directly from within Codespaces.
4. Copy your codepsaces url to be used in step 4.

## Step 3: Install Dependencies
1. Navigate to the root directory of your project.
2. Install the required dependencies from the `requirements.txt` file by running:
   ```bash
   pip install -r requirements.txt
   ```

## Step 4: Set Up Webhook in Django Repo
- Go to the Settings of your Django_Repo on which PR is to be raised  on GitHub.
- Navigate to Webhooks and click Add webhook.
- In the Payload URL, use the URL copied in step 2 generated by your Codespaces and add `-8000.app` that should look like for  
 e.g., ```https://<Random_Name>-8000.app.github.dev/webhook).```
- Set Content type to application/json.
- Under Let me select individual events, select Pull requests.
- Uncheck Pushes and save the webhook.


## Step 5: Create a Personal Access Token (PAT)
- Go to Profile settings > Developer settings > Personal access tokens on GitHub.
- Generate a new token with all  permissions (e.g., repo, workflow).
- Save the token as it will not be shown again.

## Step 6: Set Up Environment Variables

In the root directory of your repository, create a .env file with the following content:
```
# env

MY_GITHUB_TOKEN=<YOUR_PAT>
```

## Step 7: Set Up GitHub Pages Repo

- Create a new public repo say test_repo for github pages 
- In the test_repo repository, create a new branch named gh-pages.
- Update the configuration files in app.py with the following:
```
TESTS_REPO = f"https://{GITHUB_TOKEN}@github.com/<YOUR_USERNAME>/<GH_PAGES_REPO_NAME>.git"
DJANGO_REPO = f"https://{GITHUB_TOKEN}@github.com/<YOUR_USERNAME>/<DJANGO_REPO_NAME>.git"
```


## Step 8 : Configure app.py
- Edit app.py and modify the following lines:
- Line 46 to specify the path to your Django project:
```bash
django_project_path = os.path.join(repo_dir, "YOUR_DJANGO_PROJECT_NAME")
```
- On lines 77, 105, 107, 109 configure the name of your django project name

## Step 9: Configure GitHub Pages URLs
- Navigate to test_repo on github created in step 7 > settings > pages
- Copy the live link from the GitHub Pages settings of your repository.
- change your branch to gh-pages  in the branch section 
- Update the 139-141 lines in app.py:
```bash
coverage_url = f"<YOUR_PAGES_URL>/pr-{pr_number}/index.html"
test_report_url = f"<YOUR_PAGES_URL>/pr-{pr_number}/report.html"
assets_url = f"<YOUR_PAGES_URL>/pr-{pr_number}/assets/style.css"
```

## Step 10:Run the Flask Application
- Run flask server  and make port public 
- The app will be accessible on the specified port after making it public  (e.g., 8000).

## Step 11: Generate a Pull Request
- In your Django repository, create a pull request.

## Step 11: Verify the Results
- The webhook will trigger the Flask app, which will:
- Clone the Django repository.
- It will automatically run the tests with coverage and pytest.
-  It will generate HTML reports (index.html for coverage, report.html for test results).
- It will push the reports along with css assets folder to the gh-pages branch in the test_repo.
- It will post a comment on the PR with links to the generated reports and the assets.
- In case, if your django repo test cases did not run successfully so it will not create any report or comment
- Click on the links and it will redirect you on reports 

License
---
This project is licensed under the MIT License.
